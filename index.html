<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¾®å²©çŸ³è°ƒè‰²ç³»ç»Ÿ v2.4 (å‘è´§è´´çº¸ä¼˜åŒ–ç‰ˆ)</title>
  <style>
    :root { --primary:#2c3e50; --accent:#3498db; --bg:#f4f7f6; --shipment:#e67e22; --success:#27ae60; }
    * { box-sizing: border-box; }
    body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:#333; margin:0; padding:20px; }
    .container{ max-width:920px; margin:0 auto; background:#fff; padding:28px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.08); }
    h1{ text-align:center; color:var(--primary); border-bottom:2px solid #eee; padding-bottom:10px; margin:0 0 14px; }
    h2{ font-size:1.15em; color:var(--accent); margin:22px 0 10px; border-left: 4px solid var(--accent); padding-left: 10px; }
    h2.shipment-title { color: var(--shipment); border-left-color: var(--shipment); }

    .form-section{ margin-bottom:18px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
    .row{ display:flex; gap:16px; flex-wrap:wrap; margin-bottom:12px; }
    .col{ flex:1; min-width:160px; }
    label{ display:block; margin-bottom:6px; font-weight:700; font-size:.9em; }
    input,select{ width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:1em; }
    input:focus,select:focus{ outline:none; border-color:var(--accent); }

    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ padding:12px; text-align:left; border-bottom:1px solid #eee; }
    th{ background:#f8f9fa; color:var(--primary); font-weight:700; }
    
    td.highlight { color: var(--accent); font-weight: bold; }

    .btn{ border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:.95em; transition: opacity 0.2s; }
    .btn:hover { opacity: 0.9; }
    .btn-add{ background:var(--accent); color:#fff; }
    .btn-remove{ background:#e74c3c; color:#fff; padding:8px 10px; border-radius:8px; }
    .btn-img{ background:#8e44ad; color:#fff; }
    .btn-csv{ background:var(--success); color:#fff; margin-right: 10px; }
    .btn-ship{ background:var(--shipment); color:#fff; width: 100%; font-weight: bold; font-size: 1.1em; padding: 14px; }

    .tip{ font-size:.92em; color:#555; background:#eef2f3; padding:10px 12px; border-radius:10px; margin-bottom: 15px; }

    .result-panel{ margin-top:14px; border:2px dashed #bdc3c7; background:#fff; padding:18px; border-radius:12px; }
    .result-header{ display:flex; justify-content:space-between; border-bottom:2px solid #333; padding-bottom:10px; margin-bottom:12px; gap:10px; }
    
    .shipment-box { background: #fffdf0; border: 2px solid var(--shipment); padding: 15px; border-radius: 12px; margin-top: 15px; }
    .shipment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #d35400; }
    .shipment-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .shipment-item { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--shipment); }
    .shipment-item b { font-size: 1.2em; color: #d35400; display: block; margin-top: 4px; }

    .formula-list{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace; font-size:1.05em; line-height:1.55; }
    .formula-item{ display:flex; justify-content:space-between; border-bottom:1px dotted #ccc; padding:6px 0; gap:10px; }
    .base-info{ font-size:.92em; color:#666; margin-bottom:10px; background:#f9f9f9; padding:10px 12px; border-radius:10px; }

    @media (max-width: 600px){
      th,td{ white-space:nowrap; padding:10px; }
      table{ min-width: 680px; }
      th:nth-child(1), td:nth-child(1){ min-width: 140px; }
      .modal-card { width: 95%; }
    }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; z-index:9999; }
    .modal.open{ display:flex; }
    .modal-card{ background:#fff; width:min(560px, 100%); border-radius:16px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,.25); }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 10px;}
    .modal-imgwrap{ background:#e0e0e0; border:1px solid #ccc; border-radius:12px; padding:20px; overflow:auto; display: flex; justify-content: center; }
    .modal-imgwrap img{ max-width:100%; height:auto; display:block; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<div class="container">
  <h1>å¾®å²©çŸ³è°ƒè‰²ç³»ç»Ÿ v2.4 (å‘è´§è´´çº¸ä¼˜åŒ–ç‰ˆ)</h1>

  <div class="tip">
    ğŸ’¡ <b>æµç¨‹è¯´æ˜ï¼š</b> 
    <br>1. å¡«å†™æ ·æ¿æ•°æ® -> ç”Ÿæˆâ€œç•™æ¡£è´´çº¸â€æˆ–å¯¼å‡ºè¡¨æ ¼ã€‚
    <br>2. æ ·æ¿ç¡®è®¤å -> åˆ°åº•éƒ¨é€‰æ‹©å¤§è´§è§„æ ¼ -> ç”Ÿæˆâ€œå‘è´§è´´çº¸â€ã€‚
  </div>

  <!-- 1. åŸºç¡€ä¿¡æ¯ -->
  <div class="form-section">
    <h2>1. æ ·æ¿åŸºç¡€ä¿¡æ¯</h2>
    <div class="row">
      <div class="col">
        <label>é¡¹ç›®åç§°</label>
        <input id="projectName" type="text" value="æ·±åœ³å¤ªå­æ¹¾" />
      </div>
      <div class="col">
        <label>æ‰“æ ·æ—¥æœŸ</label>
        <input id="makeDate" type="date" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>å¹²ç²‰ææ–™</label>
        <select id="powderType">
          <option value="MR02" selected>MR02 (ä¸­)</option>
          <option value="MR01">MR01 (ç»†)</option>
          <option value="MR03">MR03 (ç²—)</option>
        </select>
      </div>
      <div class="col">
        <label>æ ·æ¿å¹²ç²‰é‡é‡ (g)</label>
        <select id="powderWeight">
          <option value="50">50g</option>
          <option value="100" selected>100g</option>
          <option value="150">150g</option>
          <option value="200">200g</option>
        </select>
      </div>
      <div class="col">
        <label>æ ‘è„‚æ¯”ä¾‹</label>
        <select id="resinRatio">
          <option value="30" selected>30%</option>
          <option value="0">0%</option>
          <option value="60">60%</option>
        </select>
      </div>
      <div class="col">
        <label>åŠ æ°´é‡ (g)</label>
        <input id="waterAmount" type="number" value="30" />
      </div>
    </div>
    
    <div class="row">
       <div class="col">
         <label>ç½©é¢äº®åº¦</label>
         <select id="topcoatGloss">
           <option value="12" selected>12åº¦</option>
           <option value="7">7åº¦</option>
           <option value="20">20åº¦</option>
         </select>
       </div>
       <div class="col">
         <label>æ‰“ç£¨ç ‚çº¸</label>
         <select id="sandingGrit">
           <option value="ä¸æ‰“ç£¨" selected>ä¸æ‰“ç£¨</option>
           <option value="120#">120#</option>
           <option value="240#">240#</option>
           <option value="320#">320#</option>
           <option value="400#">400#</option>
         </select>
       </div>
       <div class="col" style="flex:2;"></div>
    </div>
  </div>

  <!-- 2. è°ƒè‰²æ•°æ® -->
  <div class="form-section">
    <h2>2. æ ·æ¿è°ƒè‰²æ•°æ®</h2>
    <datalist id="colors_list"></datalist>

    <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th style="width:30%">è‰²å·</th>
          <th style="width:25%">ç¨€é‡Šæ¯”ä¾‹</th>
          <th style="width:20%">æ ·æ¿åŠ å…¥é‡(g)</th>
          <th style="width:20%">æ ‡å‡†å•ä½ (g/kg)</th>
          <th style="width:5%"></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="col"><button class="btn btn-add" onclick="addRow()">+ æ·»åŠ é¢œè‰²</button></div>
    </div>
  </div>

  <!-- 3. æ ·æ¿é¢„è§ˆ -->
  <div class="form-section">
    <h2>3. æ ·æ¿ç•™æ¡£é¢„è§ˆ</h2>
    <div class="result-panel">
      <div class="result-header">
        <div><b id="displayProject">é¡¹ç›®åç§°</b></div>
        <div><span id="displayDate"></span></div>
      </div>
      <div class="base-info" id="displayBase">
        <div id="displayBaseLine1"></div>
        <div id="displayBaseLine2"></div>
      </div>
      <div id="finalFormula" class="formula-list">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div style="text-align:right; margin-top:10px;">
        <button class="btn btn-csv" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡º CSV (Excel)</button>
        <button class="btn btn-img" onclick="generateSampleSticker()">ğŸ–¼ï¸ ç”Ÿæˆæ ·æ¿ç•™æ¡£è´´çº¸ (50Ã—70mm)</button>
      </div>
    </div>
  </div>

  <!-- 4. å¤§è´§å‘è´§è®¡ç®— -->
  <div class="form-section">
    <h2 class="shipment-title">4. å¤§è´§ç”Ÿäº§ & è‰²æµ†å‘è´§è®¡ç®—</h2>
    <div class="row" style="align-items: flex-end;">
      <div class="col">
        <label style="color:#d35400;">é€‰æ‹©å¤§è´§å¹²ç²‰è§„æ ¼ (kg/ç“¶)</label>
        <select id="prodWeight" style="border:2px solid #d35400; background:#fffcf5; font-weight:bold; font-size:1.1em; color:#d35400;">
          <option value="1">1 kg / ç“¶</option>
          <option value="2">2 kg / ç“¶</option>
          <option value="4" selected>4 kg / ç“¶</option>
          <option value="8">8 kg / ç“¶</option>
          <option value="10">10 kg / ç“¶</option>
          <option value="16">16 kg / ç“¶</option>
        </select>
      </div>
      <div class="col" style="flex:2">
         <div class="tip" style="margin:0; background:#fff8e1; color:#d35400;">
            è®¡ç®—å…¬å¼ï¼šæ­¥éª¤2çš„ <b>g/kg</b> æ ‡å‡†å€¼ Ã— å·¦ä¾§ <b>kgæ•°</b>ã€‚
         </div>
      </div>
    </div>

    <div class="shipment-box">
       <div class="shipment-header">
          <strong style="font-size:1.1em;">è‰²æµ†å‘è´§æ¸…å• (å•ç“¶ç”¨é‡)</strong>
          <span id="shipmentTag" style="background:#d35400; color:#fff; padding:2px 8px; border-radius:4px; font-size:0.85em;">4kgè§„æ ¼</span>
       </div>
       <div id="shipmentList" class="shipment-list">
          <!-- åŠ¨æ€ç”Ÿæˆå‘è´§æ•°æ® -->
          <div style="color:#999; padding:10px;">è¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ é¢œè‰²...</div>
       </div>
    </div>

    <div style="margin-top:20px;">
      <button class="btn btn-ship" onclick="generateShipmentSticker()">ğŸ“¦ ç”Ÿæˆè‰²æµ†å‘è´§è´´çº¸ (50Ã—70mm)</button>
    </div>
  </div>

</div>

<!-- å›¾ç‰‡å¼¹çª— -->
<div class="modal" id="imgModal" onclick="closeModal(event)">
  <div class="modal-card">
    <div class="modal-head">
      <b id="modalTitle">è´´çº¸é¢„è§ˆ</b>
      <button class="btn" onclick="closeModal(event)" style="background:#eee;">å…³é—­</button>
    </div>
    <div class="modal-actions">
      <a id="downloadLink" class="btn btn-img" href="#" download="sticker.png">ä¸‹è½½ PNG</a>
      <span style="font-size:.9em; color:#666; align-self:center; margin-left:auto;">iPhone: é•¿æŒ‰å›¾ç‰‡ä¿å­˜</span>
    </div>
    <div class="modal-imgwrap">
      <img id="stickerImg" alt="sticker" />
    </div>
  </div>
</div>

<script>
  // å¸¸ç”¨è‰²å·
  const colorCodes = ['NSC01','NSC02','NSC03','NSC04','NSC05','NSC113','NSC114','NSC115','NSC116','NSC117','XY','XR','Xk','NC','KF','TG','yama','Wæ°´','Wä¸–'];
  document.getElementById('colors_list').innerHTML = colorCodes.map(c => `<option value="${c}"></option>`).join('');

  // åˆå§‹åŒ–æ—¥æœŸ
  function setToday(){
    const d = new Date();
    const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    document.getElementById('makeDate').value = iso;
  }

  // é¡µé¢åŠ è½½
  window.addEventListener('load', () => {
    setToday();
    // é»˜è®¤ç¤ºä¾‹æ•°æ®
    addRow('NSC05', '0.1', 0.7);
    addRow('NSC03', '0.1', 0.7);
    addRow('NSC117', '0.1', 0.3);
    updateAll();
  });

  // ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–
  const allInputs = ['projectName','makeDate','powderType','powderWeight','resinRatio','waterAmount','topcoatGloss','sandingGrit','prodWeight'];
  allInputs.forEach(id => {
    document.getElementById(id).addEventListener('input', updateAll);
    document.getElementById(id).addEventListener('change', updateAll);
  });

  // æ ¸å¿ƒï¼šæ·»åŠ è¡Œ
  function addRow(code='', ratioVal='0.1', weight=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" list="colors_list" class="input-code" value="${code}" placeholder="è‰²å·" /></td>
      <td>
        <select class="input-ratio">
          <option value="1" ${Number(ratioVal)===1?'selected':''}>åŸæµ†</option>
          <option value="0.1" ${Number(ratioVal)===0.1?'selected':''}>1:10</option>
          <option value="0.01" ${Number(ratioVal)===0.01?'selected':''}>1:100</option>
        </select>
      </td>
      <td><input type="number" step="0.01" class="input-weight" value="${weight}" placeholder="0.00" /></td>
      <td class="highlight"><span class="result-cell">-</span></td>
      <td><button class="btn-remove" onclick="removeRow(this)">Ã—</button></td>
    `;
    document.getElementById('tableBody').appendChild(tr);

    // ç»‘å®šè¡Œå†…äº‹ä»¶
    tr.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', updateAll);
        el.addEventListener('change', updateAll);
    });
    updateAll();
  }

  function removeRow(btn){
    btn.closest('tr').remove();
    updateAll();
  }

  // å…¨å±€æ›´æ–°å…¥å£
  function updateAll() {
    calculateStandard(); // è®¡ç®— g/kg
    updateSamplePanel(); // æ›´æ–°æ ·æ¿é¢„è§ˆUI
    updateShipmentPanel(); // æ›´æ–°å¤§è´§å‘è´§UI
  }

  // 1. è®¡ç®—æ ‡å‡†å•ä½ (g/kg) å¹¶æ˜¾ç¤ºåœ¨è¡¨æ ¼ä¸­
  function calculateStandard(){
    const powderWeight = Number(document.getElementById('powderWeight').value);
    const powderKg = powderWeight / 1000;
    
    document.querySelectorAll('#tableBody tr').forEach(row => {
      const ratioVal = Number(row.querySelector('.input-ratio').value || 0);
      const weight = Number(row.querySelector('.input-weight').value || 0);
      const cell = row.querySelector('.result-cell');
      
      if (powderKg > 0 && weight) {
        // å…¬å¼ï¼š(å®é™…åŠ å…¥g * ç¨€é‡Šæ¯”ä¾‹) / å¹²ç²‰kgæ•° = æ¯å…¬æ–¤å¹²ç²‰éœ€è¦çš„åŸæµ†gæ•°
        const std = (weight * ratioVal) / powderKg;
        // å­˜å‚¨åœ¨dataseté‡Œä¾›åç»­è°ƒç”¨ï¼Œé¿å…é‡å¤è®¡ç®—
        row.dataset.std = std; 
        row.dataset.code = row.querySelector('.input-code').value;
        cell.textContent = std.toFixed(2);
      } else {
        row.dataset.std = 0;
        cell.textContent = '-';
      }
    });
  }

  // 2. æ›´æ–°æ ·æ¿é¢„è§ˆé¢æ¿
  function updateSamplePanel(){
    const project = document.getElementById('projectName').value || 'æœªå‘½åé¡¹ç›®';
    const date = document.getElementById('makeDate').value;
    const powderType = document.getElementById('powderType').value;
    const powderW = document.getElementById('powderWeight').value;
    const resin = (Number(powderW) * document.getElementById('resinRatio').value / 100).toFixed(1);
    const water = document.getElementById('waterAmount').value;
    const gloss = document.getElementById('topcoatGloss').value;
    const grit = document.getElementById('sandingGrit').value;

    document.getElementById('displayProject').textContent = project;
    document.getElementById('displayDate').textContent = date;
    document.getElementById('displayBaseLine1').textContent = `${powderType} (${powderW}g) æ ‘è„‚${resin}g æ°´${water}g`;
    document.getElementById('displayBaseLine2').textContent = `ç½©é¢${gloss}åº¦  ç ‚çº¸${grit}`;

    // åˆ—è¡¨ç”Ÿæˆ
    const rows = document.querySelectorAll('#tableBody tr');
    let html = '';
    rows.forEach(row => {
       const code = row.querySelector('.input-code').value;
       const std = parseFloat(row.dataset.std || 0);
       const ratioTxt = row.querySelector('.input-ratio').selectedOptions[0].text;
       const w = row.querySelector('.input-weight').value;
       
       if(code && std > 0) {
           html += `<div class="formula-item">
             <span>${code} <small style="color:#888">(${ratioTxt}:${w}g)</small></span>
             <span><b>${std.toFixed(2)}</b> g/kg</span>
           </div>`;
       }
    });
    document.getElementById('finalFormula').innerHTML = html || '<div style="color:#999;text-align:center">æš‚æ— æœ‰æ•ˆæ•°æ®</div>';
  }

  // 3. æ›´æ–°å¤§è´§å‘è´§é¢æ¿
  function updateShipmentPanel() {
      const prodKg = Number(document.getElementById('prodWeight').value);
      document.getElementById('shipmentTag').textContent = `ç”¨é‡ ${prodKg}kg/ç“¶`;

      const rows = document.querySelectorAll('#tableBody tr');
      let html = '';
      let hasData = false;

      rows.forEach(row => {
          const code = row.querySelector('.input-code').value;
          const std = parseFloat(row.dataset.std || 0); // è·å– g/kg
          
          if(code && std > 0) {
              hasData = true;
              // æ ¸å¿ƒè®¡ç®—ï¼šæ ‡å‡†é‡ * å¤§è´§å…¬æ–¤æ•°
              const finalWeight = std * prodKg; 
              
              html += `
                <div class="shipment-item">
                    <div style="font-weight:bold; color:#555;">${code}</div>
                    <div><b>${finalWeight.toFixed(2)} g</b></div>
                </div>
              `;
          }
      });

      document.getElementById('shipmentList').innerHTML = hasData ? html : '<div style="grid-column:1/-1; color:#999; text-align:center;">æš‚æ— æœ‰æ•ˆé…æ–¹æ•°æ®</div>';
  }

  // ========== æ–°å¢ï¼šå¯¼å‡º CSV (Excel) ==========
  function exportToCSV() {
    const project = document.getElementById('projectName').value || 'æœªå‘½å';
    const date = document.getElementById('makeDate').value;
    const base1 = document.getElementById('displayBaseLine1').textContent;
    const base2 = document.getElementById('displayBaseLine2').textContent;

    // æ·»åŠ  BOM \uFEFF è§£å†³ Excel ä¸­æ–‡ä¹±ç é—®é¢˜
    let csvContent = "\uFEFF"; 
    
    csvContent += `é¡¹ç›®åç§°,${project}\n`;
    csvContent += `æ‰“æ ·æ—¥æœŸ,${date}\n`;
    csvContent += `åŸºç¡€é…æ–¹,${base1}\n`;
    csvContent += `å·¥è‰ºè¦æ±‚,${base2}\n\n`;
    
    csvContent += "è‰²å·,ç¨€é‡Šæ¯”ä¾‹,å®é™…åŠ å…¥é‡(g),æ ‡å‡†å•ä½(g/kg)\n";

    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(row => {
        const code = row.querySelector('.input-code').value;
        const ratioTxt = row.querySelector('.input-ratio').selectedOptions[0].text;
        const weight = row.querySelector('.input-weight').value;
        const std = parseFloat(row.dataset.std || 0).toFixed(2);
        
        if(code && weight) {
           // CSV æ ¼å¼ï¼šè‰²å·,æ¯”ä¾‹,å®é™…é‡,æ ‡å‡†é‡
           csvContent += `${code},${ratioTxt},${weight},${std}\n`;
        }
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `${project}_é…æ–¹è¡¨_${date}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // ========== Canvas ç»˜å›¾é€šç”¨é€»è¾‘ (50x70mm) ==========
  function mmToPx(mm, dpi=203) { return Math.round(mm / 25.4 * dpi); }
  
  // æ–‡å­—æ¢è¡Œå·¥å…·
  function wrapText(ctx, text, maxWidth){
    const chars = String(text).split('');
    const lines = [];
    let line = '';
    for (const ch of chars){
      const test = line + ch;
      if (ctx.measureText(test).width > maxWidth && line){
        lines.push(line);
        line = ch;
      } else {
        line = test;
      }
    }
    if (line) lines.push(line);
    return lines;
  }

  // é€šç”¨ç”»æ¿åˆå§‹åŒ–
  function initCanvas() {
      const dpi = 203; // çƒ­æ•æ‰“å°æœºå¸¸ç”¨DPI
      const W = mmToPx(50, dpi);
      const H = mmToPx(70, dpi);
      const canvas = document.createElement('canvas');
      canvas.width = W;
      canvas.height = H;
      const ctx = canvas.getContext('2d');
      // ç™½åº•
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = '#000';
      return { canvas, ctx, W, H, ppm: dpi/25.4 };
  }

  // A. ç”Ÿæˆæ ·æ¿è´´çº¸ (æ›´æ–°ç‰ˆï¼šä¸‹åŠéƒ¨å­—ä½“åŠ å¤§)
  function generateSampleSticker() {
      const { canvas, ctx, W, H, ppm } = initCanvas();
      const mx = 2*ppm; 
      let y = 3*ppm;

      // 1. æ ‡é¢˜ï¼šé¡¹ç›®
      const project = document.getElementById('projectName').value || 'æœªå‘½å';
      ctx.fillStyle = '#000';
      ctx.font = `900 ${3.5*ppm}px sans-serif`; // ç¨å¾®è°ƒå°ä¸€ç‚¹ç‚¹ç»™ä¸‹é¢è…¾ä½ç½®
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      
      const titleLines = wrapText(ctx, project, W-4*ppm);
      titleLines.slice(0,2).forEach(l => { 
          ctx.fillText(l, W/2, y); 
          y+=3.8*ppm; 
      });

      // 2. æ—¥æœŸ
      ctx.font = `${2.4*ppm}px sans-serif`;
      ctx.fillText(document.getElementById('makeDate').value, W/2, y);
      y += 3.5*ppm;

      // è·å–æ•°æ®
      const rows = document.querySelectorAll('#tableBody tr');

      // 3. ä¸ŠåŠéƒ¨åˆ†ï¼šæ ‡å‡†å•ä½ (g/kg) - ä¿æŒæ¸…æ™°å³å¯
      ctx.font = `bold ${3.0*ppm}px sans-serif`; 
      rows.forEach(row => {
          const code = row.dataset.code;
          const std = parseFloat(row.dataset.std||0);
          if(code && std > 0) {
              ctx.textAlign = 'left';
              ctx.fillText(code, mx, y);
              
              ctx.textAlign = 'right';
              ctx.fillText(`${std.toFixed(2)} g/kg`, W-mx, y);
              y += 3.5*ppm;
          }
      });

      y += 1.0*ppm;

      // 4. åˆ†å‰²çº¿
      ctx.beginPath(); 
      ctx.moveTo(mx,y); 
      ctx.lineTo(W-mx,y); 
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 1.5;
      ctx.stroke(); 
      y+=3.0*ppm;

      // 5. å®éªŒåŸºç¡€ä¿¡æ¯ (åŠ ç²—ï¼ŒåŠ å¤§)
      const base1 = document.getElementById('displayBaseLine1').textContent;
      const base2 = document.getElementById('displayBaseLine2').textContent;
      
      ctx.textAlign = 'left';
      // å­—ä½“åŠ å¤§åˆ° 2.6ppm å¹¶åŠ ç²—
      ctx.font = `bold ${2.6*ppm}px sans-serif`; 
      
      wrapText(ctx, base1, W-2*mx).forEach(l => { ctx.fillText(l, mx, y); y+=3.2*ppm; });
      wrapText(ctx, base2, W-2*mx).forEach(l => { ctx.fillText(l, mx, y); y+=3.8*ppm; });

      // 6. ä¸‹åŠéƒ¨åˆ†ï¼šå®éªŒå…·ä½“åŠ å…¥é‡ (é‡ç‚¹ï¼šåŠ å¤§å­—ä½“ï¼Œæ–¹ä¾¿å¸ˆå‚…çœ‹)
      // å­—ä½“åŠ å¤§åˆ° 3.4ppmï¼Œä¸ä¸ŠåŠéƒ¨ä¸»æ•°æ®ç›¸å½“ï¼Œç”šè‡³æ›´å¤§
      ctx.font = `bold ${3.4*ppm}px sans-serif`; 
      
      rows.forEach(row => {
          const code = row.dataset.code;
          const std = parseFloat(row.dataset.std||0);
          
          if(code && std > 0) {
              const ratioTxt = row.querySelector('.input-ratio').selectedOptions[0].text;
              const weight = row.querySelector('.input-weight').value;
              
              // å·¦ä¾§ï¼šè‰²å· (æ¯”ä¾‹)
              ctx.textAlign = 'left';
              // æ¯”ä¾‹å­—ç¨å¾®å°ä¸€ç‚¹ç‚¹ï¼Œé¿å…å¤ªé•¿æ¢è¡Œ
              const leftText = `${code} (${ratioTxt})`;
              
              // å¦‚æœæ–‡å­—å¤ªé•¿ï¼Œç¨å¾®ç¼©å°ä¸€ç‚¹å­—å·
              if(ctx.measureText(leftText).width > (W/2 + 10)) {
                 ctx.font = `bold ${2.8*ppm}px sans-serif`;
              } else {
                 ctx.font = `bold ${3.4*ppm}px sans-serif`;
              }
              ctx.fillText(leftText, mx, y);
              
              // å³ä¾§ï¼šå®é™…å…‹é‡ (ä¿æŒå¤§å­—ä½“)
              ctx.font = `bold ${3.4*ppm}px sans-serif`;
              ctx.textAlign = 'right';
              ctx.fillText(`${weight}g`, W-mx, y);
              
              y += 4.0*ppm; // è¡Œé«˜å¢åŠ 
          }
      });

      openModal(canvas, "æ ·æ¿ç•™æ¡£è´´çº¸");
  }

  // B. ç”Ÿæˆå‘è´§è´´çº¸ (ä¼˜åŒ–ç‰ˆï¼šé¡¹ç›®åç½®é¡¶ï¼Œç”¨é‡ç™½åº•é»‘å­—)
  function generateShipmentSticker() {
      const { canvas, ctx, W, H, ppm } = initCanvas();
      const mx = 2*ppm; 
      let y = 3*ppm; 

      const project = document.getElementById('projectName').value || 'æœªå‘½å';
      const prodKg = document.getElementById('prodWeight').value;
      const date = document.getElementById('makeDate').value;

      // 1. é¡¶éƒ¨æ”¹ä¸ºï¼šé¡¹ç›®åç§° (åŠ ç²—ï¼Œå±…ä¸­)
      ctx.fillStyle = '#000';
      ctx.font = `900 ${3.8*ppm}px sans-serif`; 
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      
      // å¤„ç†é•¿é¡¹ç›®åæ¢è¡Œ
      const titleLines = wrapText(ctx, `é¡¹ç›®ï¼š${project}`, W-mx);
      titleLines.forEach(l => {
         ctx.fillText(l, W/2, y);
         y += 5.0*ppm;
      });
      // y += 1.0*ppm;

      // 2. è§„æ ¼æ¡† (æ”¹åŠ¨ï¼šç™½åº•é»‘å­—ï¼Œå­—ä½“åŠ å¤§)
      // å»æ‰ fillRect é»‘è‰²èƒŒæ™¯
      const specText = `ç”¨é‡: ${prodKg}kg / ç“¶`;
      
      ctx.fillStyle = '#000'; // é»‘å­—
      ctx.font = `900 ${5.0*ppm}px sans-serif`; // å­—ä½“åŠ å¤§ (åŸæ¥æ˜¯3.0)
      ctx.textBaseline = 'top';
      ctx.fillText(specText, W/2, y); 
      
      y += 6.5*ppm; // ç•™å‡ºç©ºé—´

      // 3. ä¿¡æ¯åŒºåŸŸ (ä¿ç•™æ—¥æœŸï¼Œå»æ‰é‡å¤çš„é¡¹ç›®å)
      ctx.fillStyle = '#000';
      ctx.textAlign = 'left';
      ctx.font = `${2.4*ppm}px sans-serif`;
      
      // åŸæ¥çš„é¡¹ç›®åè¡Œç°åœ¨åœ¨é¡¶éƒ¨ï¼Œæ‰€ä»¥è¿™é‡Œåªä¿ç•™æ—¥æœŸï¼Œä¿æŒâ€œå…¶ä½™ä¸æ”¹â€çš„ç»“æ„
      ctx.fillText(`æ—¥æœŸ: ${date}`, mx, y);
      y += 4*ppm; 

      // 4. åˆ†å‰²çº¿
      ctx.beginPath(); 
      ctx.moveTo(mx, y); 
      ctx.lineTo(W-mx, y); 
      ctx.lineWidth = 2;
      ctx.stroke();
      y += 2*ppm;

      // 5. è‰²æµ†åˆ—è¡¨
      const rows = document.querySelectorAll('#tableBody tr');
      let hasItem = false;

      rows.forEach(row => {
          const code = row.dataset.code;
          const std = parseFloat(row.dataset.std || 0);
          
          if(code && std > 0) {
              hasItem = true;
              const finalW = (std * Number(prodKg)).toFixed(2); 
              
              ctx.textAlign = 'left';
              ctx.font = `bold ${3.2*ppm}px sans-serif`;
              ctx.fillText(code, mx, y);

              ctx.textAlign = 'right';
              ctx.font = `900 ${3.8*ppm}px sans-serif`; 
              ctx.fillText(`${finalW}g`, W-mx, y); 

              y += 5.0*ppm; 
          }
      });

      if(!hasItem) {
        ctx.textAlign = 'center';
        ctx.font = `${2.5*ppm}px sans-serif`;
        ctx.fillText("æ— è‰²æµ†æ•°æ®", W/2, y+5*ppm);
      }

      openModal(canvas, `å‘è´§è´´çº¸ (${prodKg}kg)`);
  }

  function openModal(canvas, title) {
    const dataUrl = canvas.toDataURL('image/png');
    document.getElementById('stickerImg').src = dataUrl;
    document.getElementById('downloadLink').href = dataUrl;
    document.getElementById('downloadLink').download = `${title}.png`;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('imgModal').classList.add('open');
  }

  function closeModal(e) {
    if (e) e.stopPropagation();
    document.getElementById('imgModal').classList.remove('open');
  }
</script>

</body>
</html>